#!/usr/bin/env node

var spawn = require('child_process').spawn;
var path = require("path");
var pargs = process.argv.slice(2);

var options = (function(args){
	var r = {path: "./"};
	while(args.length){
		var a = args.shift();
		if (a.indexOf("/") >Â -1) {
			r.path = a;
		}else{
			r.app = a;
		}
	}
	return r;
})(pargs);

options.path = path.resolve(options.path)
var cmd = path.join(__dirname,"node_modules",".bin","forever");

process.env.NODE_PATH= [__dirname, options.path, path.join(__dirname,"node_modules") ].join(path.delimiter);
console.log(process.env.NODE_PATH);
require("./lib/utils").getConfiguration(options.path, options.app, function(err, keys){
	if (err) {
		console.error(err);
		process.exit(0);
	}else{
		var foreverArgs = ["--minUptime", "5000ms", "--spinSleepTime", "5000ms", "--colors"];
		if (typeof process.env.DEBUG !== "undefined") {
			console.log("Debug mode...");
			foreverArgs.push("-c","node --debug");
		}
		foreverArgs.push("--watchDirectory", options.path);
		// Launch Script
		foreverArgs.push(path.join(__dirname, "index.js"));
		// Launch Path
		foreverArgs.push(options.path)
		// App Name
		foreverArgs.push(options.app)
		// Configuration
		foreverArgs.push(JSON.stringify(keys));

		spawn(cmd, foreverArgs, {'stdio': 'inherit', env: process.env });
	}
});
